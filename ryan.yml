---
- hosts: ryan.cengia.id.au
  user: root
  vars:
    motd_warning: "WARNING: You are connected to {{inventory_hostname}}. Unauthorised access is prohibited!\n"

  tasks:

    #- name: etckeeper pre-commit
    #  command: etckeeper commit "Pre-Ansible Changes"

    - name: Setup a MOTD
      copy:
        dest: /etc/motd
        content: "{{ motd_warning }}"

    - name: Update APT package cache
      apt: update_cache=yes

    #- name: Upgrade APT to the lastest packages
    #  apt: upgrade=safe

    - name: Install unattended-upgrades
      apt: pkg=unattended-upgrades state=present

    - name: Install python-augeas
      apt: pkg=python-augeas state=latest

    # Firewall

    - name: Install iptables-persistent
      apt: pkg=iptables-persistent state=latest

    - name: Create firwall config dir
      file: path=/etc/iptables state=directory mode=0755 owner=root
      notify: etckeeper post-commit

    - name: Copy in ipv4 firewall rule files
      action: copy src=ryan-files/rules.v4 dest=/etc/iptables/rules.v4 mode=0744
      notify:
        - restart iptables-persistent
        - etckeeper post-commit

    - name: Copy in ipv6 firewall rule files
      action: copy src=ryan-files/rules.v6 dest=/etc/iptables/rules.v6 mode=0744
      notify:
        - restart iptables-persistent
        - etckeeper post-commit

    # SSH

    - name: Lock down SSH
      augeas: command="set" path="/files/etc/ssh/sshd_config/PermitRootLogin" value="without-password"
      notify: restart openssh-server

    # Postfix

    - name: install postfix
      apt: pkg=postfix state=latest

    # Correctly set localhost entry in /etc/hosts
    - include: roles/common/localhost_hostname.yml

# sudo augtool -s set /files/etc/postfix/main.cf/relayhost '[cengia.id.au]:1025'
# sudo augtool -s set /files/etc/postfix/main.cf/relay_domains cengia.id.au
# sudo augtool -s set /files/etc/postfix/main.cf/mydestination "'ryan.cengia.id.au, localhost.localdomain, localhost'"
# sudo augtool -s set /files/etc/postfix/main.cf/recipient_delimiter -

  handlers:

    - name: restart iptables-persistent
      service:
        name: iptables-persistent
        state: restarted

    - name: restart openssh-server
      service:
        name: openssh-sever
        state: restarted

    - name: etckeeper post-commit
      command: etckeeper commit "Post-Ansible Changes"

